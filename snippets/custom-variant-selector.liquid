<div id="cvs-{{ section.id }}-{{ block.id }}" class="custom-variant-selector">

  {% assign displayed_variants = product.variants | slice: 0, 3 %}

  {% for variant in displayed_variants %}
    <label class="custom-variant-selector__block{% if forloop.first %} selected{% endif %}"
       data-variant-id="{{ variant.id }}"
       data-o1="{{ variant.option1 | escape }}"
       data-o2="{{ variant.option2 | escape }}"
       data-o3="{{ variant.option3 | escape }}">

      <span class="variant-indicator"></span>
      <input type="radio" name="custom_variant_id" class="hidden-radio" value="{{ variant.id }}" {% if forloop.first %}checked{% endif %}>
      <div class="variant-card">
        {% if forloop.index == 2 %}
  <div class="variant-badge">Économisez 50€</div>
{% endif %}

    {% if variant.metafields.custom.custom_image %}
  <img
    src="{{ variant.metafields.custom.custom_image | image_url: width: 300 }}"
    alt="{{ variant.title }}"
    class="{% if forloop.index == 1 %}img-small{% else %}img-large{% endif %}">
{% elsif variant.featured_media %}
  <img
    src="{{ variant.featured_media.preview_image | image_url: width: 300 }}"
    alt="{{ variant.title }}"
    class="{% if forloop.index == 1 %}img-small{% else %}img-large{% endif %}">
{% endif %}


        <p class="variant-label">{{ variant.title }}</p>
<div class="variant-price">
  {% if variant.compare_at_price > variant.price %}
    <span class="old-price">{{ variant.compare_at_price | money }}</span>
  {% endif %}
  <span class="current-price">{{ variant.price | money }}</span>
</div>
      </div>
    </label>
  {% endfor %}
</div>

<style>
.custom-variant-selector{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr)); /* deux colonnes permanentes */
  gap:12px;
  margin-top:20px;
}
  .hidden-radio {
  display: none;
}


/* chaque carte occupe exactement sa colonne */
.custom-variant-selector__block{
  width:100%;                 /* ← la grille gère la largeur */
  box-sizing:border-box;
  border:2px solid #ccc;
  border-radius:10px;
  padding:10px;
  text-align:center;
  position:relative;
  cursor:pointer;
  transition:all .2s ease;
}
.variant-card {
  display: flex;
  flex-direction: column;
  justify-content: flex-end; /* aligne le contenu vers le bas */
  height: 150px; /* fixe une même hauteur pour toutes les cartes */
}

.variant-card img.img-small {
  height: 50px;
  object-fit: contain;
  align-self: center;
}

.variant-card img.img-large {
  height: 70px;
  object-fit: contain;
  align-self: center;
}

.custom-variant-selector__block.selected{
  border-color:#000;
  background:#f6f6f6;
}

/*  décorations inchangées  */
.variant-badge {
  position: absolute;
  top: 6px;
  left: 50%;
  transform: translateX(-50%);
  background: #1A1A1A;
  color: white;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 6px;
  white-space: nowrap;       /* empêche le retour à la ligne */
  overflow: hidden;          /* masque le débordement */
  text-overflow: ellipsis;   /* ajoute "..." si trop long */
  max-width: 90%;            /* limite la largeur */
  z-index: 2;
}
  .variant-price {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  margin-top: 4px;
  font-size: 14px;
}

.old-price {
  text-decoration: line-through;
  color: #999;
  font-size: 14px;
}

.current-price {
  font-weight: bold;
  color: #000;
}


.variant-indicator{
  width:10px;height:10px;border-radius:50%;
  border:2px solid #000;position:absolute;top:10px;right:10px;
}
.custom-variant-selector__block.selected .variant-indicator{background:#000}

</style>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const root = document.getElementById("cvs-{{ section.id }}-{{ block.id }}") 
              || document.querySelector(".custom-variant-selector");
    if (!root) return;

    const VARIANTS = {{ product.variants | json }};
    const OPT_COUNT = {{ product.options | size }};

    // --- Trouve le bouton ATC et SON form ---
    const addBtn = root.closest('section')?.querySelector('button[name="add"], button[type="submit"]:not(.shopify-payment-button__button)') 
                || document.querySelector('button[name="add"], button[type="submit"]:not(.shopify-payment-button__button)');
    if (!addBtn) return;
    const form = addBtn.closest('form');
    if (!form) return;

    // Sélecteurs plausibles d’ouverture de tiroir (élargis pour Shrine-like)
    const OPENERS = [
      '[data-cart-drawer-open]', '[data-action="open-cart"]', '.js-openCartDrawer',
      'button.header__cart-button', '.header__icon--cart', '.site-header__cart',
      '.cart-toggle', '.open-cart', '#CartDrawer-Open'
    ];
    const DRAWER_OPEN = [
      '[data-cart-drawer].is-open', '.cart-drawer.is-open', '.js-cartDrawer.is-open',
      'body.cart-open', 'body.drawer--cart-open'
    ];

    const blocks = Array.from(root.querySelectorAll('.custom-variant-selector__block'));

    function byId(id){ return VARIANTS.find(v => String(v.id) === String(id)); }
    function byOptions(o1,o2,o3){
      return VARIANTS.find(v => {
        const o = v.options;
        return (o[0] == o1) && (OPT_COUNT < 2 || o[1] == o2) && (OPT_COUNT < 3 || o[2] == o3);
      });
    }

    function setNativeOption(i, val){
      // radios options[i]
      const radios = form.querySelectorAll(`input[type="radio"][name="options[${i}]"]`);
      if (radios.length){
        const r = Array.from(radios).find(x => x.value === val && !x.disabled);
        if (r && !r.checked){ r.click(); return true; }
      }
      // select options[i]
      const sel = form.querySelector(`select[name="options[${i}]"]`);
      if (sel && sel.value !== val){
        sel.value = val;
        sel.dispatchEvent(new Event('input',{bubbles:true}));
        sel.dispatchEvent(new Event('change',{bubbles:true}));
        return true;
      }
      // group Dawn-like
      const gsel = form.querySelector(`[data-index="option${i}"] select`);
      if (gsel && gsel.value !== val){
        gsel.value = val;
        gsel.dispatchEvent(new Event('input',{bubbles:true}));
        gsel.dispatchEvent(new Event('change',{bubbles:true}));
        return true;
      }
      const grad = form.querySelectorAll(`[data-index="option${i}"] input[type="radio"]`);
      if (grad.length){
        const r2 = Array.from(grad).find(x => x.value === val && !x.disabled);
        if (r2 && !r2.checked){ r2.click(); return true; }
      }
      return false;
    }

    function ensureIdField(variantId){
      const sel = form.querySelector('select[name="id"]');
      if (sel){
        if (String(sel.value) !== String(variantId)){
          sel.value = String(variantId);
          sel.dispatchEvent(new Event('input',{bubbles:true}));
          sel.dispatchEvent(new Event('change',{bubbles:true}));
        }
        return;
      }
      let hid = form.querySelector('input[name="id"][data-cvs="1"]') || form.querySelector('input[name="id"]');
      if (!hid){
        hid = document.createElement('input');
        hid.type = 'hidden'; hid.name = 'id'; hid.setAttribute('data-cvs','1');
        form.appendChild(hid);
      }
      if (String(hid.value) !== String(variantId)){
        hid.value = String(variantId);
        form.dispatchEvent(new Event('input',{bubbles:true}));
        form.dispatchEvent(new Event('change',{bubbles:true}));
      }
    }

    function setATCEnabled(enabled){
      addBtn.disabled = !enabled;
      addBtn.setAttribute('aria-disabled', String(!enabled));
    }

    function uiLoading(on){
      addBtn.classList.toggle('is-loading', !!on);
      if (on) addBtn.setAttribute('data-cvs-busy','1'); else addBtn.removeAttribute('data-cvs-busy');
    }

    function openDrawerUI(){
      // essais d’événements courants
      document.dispatchEvent(new CustomEvent('cart:refresh',{detail:{source:'cvs'}}));
      document.dispatchEvent(new CustomEvent('cart:open',{detail:{source:'cvs'}}));
      document.dispatchEvent(new CustomEvent('product:added',{detail:{source:'cvs'}}));
      // classes body fréquentes
      document.body.classList.add('cart-open');
      document.body.classList.add('drawer--cart-open');
      // clic sur un opener s’il existe
      const opener = OPENERS.map(s => document.querySelector(s)).find(Boolean);
      if (opener) opener.click();
    }

    function drawerSeemsOpen(){
      return DRAWER_OPEN.some(s => document.querySelector(s));
    }

    function selectCard(card){
      if (!card) return;
      blocks.forEach(b => b.classList.remove('selected'));
      card.classList.add('selected');
      const r = card.querySelector('input[type="radio"]'); if (r) r.checked = true;

      const o1 = card.dataset.o1 || null;
      const o2 = OPT_COUNT >= 2 ? (card.dataset.o2 || null) : null;
      const o3 = OPT_COUNT >= 3 ? (card.dataset.o3 || null) : null;

      if (o1) setNativeOption(1, o1);
      if (OPT_COUNT >= 2 && o2) setNativeOption(2, o2);
      if (OPT_COUNT >= 3 && o3) setNativeOption(3, o3);

      let v = byOptions(o1,o2,o3) || (card.dataset.variantId ? byId(card.dataset.variantId) : null);
      if (v){
        ensureIdField(v.id);
        setATCEnabled(v.available);
        form.dispatchEvent(new Event('product:options:changed',{bubbles:true}));
        document.dispatchEvent(new CustomEvent('variant:changed',{detail:{variant:v},bubbles:true}));
      }
    }

    blocks.forEach(card=>{
      card.addEventListener('click', function(e){
        e.preventDefault();
        selectCard(this);
      });
    });

    function reflectFromNative(){
      const getVal = (i)=>{
        const sel = form.querySelector(`select[name="options[${i}]"]`) || form.querySelector(`[data-index="option${i}"] select`);
        if (sel) return sel.value;
        const r = form.querySelector(`input[type="radio"][name="options[${i}]"]:checked`) || form.querySelector(`[data-index="option${i}"] input[type="radio"]:checked`);
        return r ? r.value : null;
      };
      const o1 = getVal(1), o2 = OPT_COUNT>=2 ? getVal(2) : null, o3 = OPT_COUNT>=3 ? getVal(3) : null;
      const v = byOptions(o1,o2,o3);
      if (!v) return;

      const target = blocks.find(b => (b.dataset.o1===o1) && (OPT_COUNT<2 || b.dataset.o2===o2) && (OPT_COUNT<3 || b.dataset.o3===o3))
                   || blocks.find(b => String(b.dataset.variantId) === String(v.id));
      if (target){
        blocks.forEach(b => b.classList.remove('selected'));
        target.classList.add('selected');
        const r = target.querySelector('input[type="radio"]'); if (r) r.checked = true;
      }
      ensureIdField(v.id);
      setATCEnabled(v.available);
    }

    form.addEventListener('change', function(e){
      if (e.target.matches('select[name^="options["], input[type="radio"][name^="options["]')) {
        reflectFromNative();
      }
    }, true);

    // Init
    (function init(){
      const idField = form.querySelector('select[name="id"], input[name="id"]');
      const currentId = (idField && idField.value) || "{{ product.selected_or_first_available_variant.id }}";
      let initialCard = blocks.find(b => String(b.dataset.variantId) === String(currentId)) || blocks[0] || null;
      if (initialCard) selectCard(initialCard);
    })();

    // --- Pré-injection avant submit/click (ne bloque rien) ---
    function preflight(){
      const active = root.querySelector('.custom-variant-selector__block.selected') || blocks[0];
      if (!active) return;
      const v = byOptions(active.dataset.o1, active.dataset.o2, active.dataset.o3) || byId(active.dataset.variantId);
      if (v){ ensureIdField(v.id); setATCEnabled(v.available); }
    }
    form.addEventListener('submit', preflight, true);
    addBtn.addEventListener('click', preflight, true);

    // --- Fallback AJAX (sans bloquer le thème, sans double ajout) ---
    let inflight = false;
    form.addEventListener('submit', function(){
      // Lance un timer très court : si le thème n’ouvre pas le tiroir, on ajoute via AJAX
      setTimeout(async ()=>{
        try{
          if (inflight) return;
          if (drawerSeemsOpen()) return; // le thème a géré
          // Vérifie si un id est dans FormData (sinon, on l’ajoute)
          const fd = new FormData(form);
          let id = fd.get('id');
          if (!id){
            const active = root.querySelector('.custom-variant-selector__block.selected') || blocks[0];
            const v = active ? (byOptions(active.dataset.o1, active.dataset.o2, active.dataset.o3) || byId(active.dataset.variantId)) : null;
            if (!v) return;
            fd.set('id', v.id);
            id = v.id;
          }

          inflight = true;
          uiLoading(true);

          const res = await fetch('/cart/add.js', { method:'POST', body:fd, headers:{'Accept':'application/json'} });
          // Même si non-ok, on relâche l’état UI :
          uiLoading(false);
          inflight = false;

          if (!res.ok) return;

          // Signale ajout + ouvre le tiroir
          document.dispatchEvent(new CustomEvent('cart:added', {detail:{source:'cvs'}}));
          openDrawerUI();
        }catch(e){
          uiLoading(false);
          inflight = false;
        }
      }, 0);
    }); // NOTE: pas de {once:true} => multi-ajouts successifs ok
  });
})();
</script>




