{%- comment -%} Snippet: variant-visual-selector.liquid {%- endcomment -%}
<div class="pvv-wrap" id="pvv-{{ section.id }}-{{ block.id }}">
  <fieldset class="pvv-grid" role="radiogroup" aria-label="Variantes">
    {%- assign current = product.selected_or_first_available_variant -%}
    {%- for v in product.variants -%}
      <label class="pvv-card" data-vid="{{ v.id }}" aria-pressed="{% if v.id == current.id %}true{% else %}false{% endif %}">

        <input class="pvv-radio" type="radio" name="pvv-{{ block.id }}" value="{{ v.id }}"
               {% if v.id == current.id %}checked{% endif %}
               {% unless v.available %}disabled{% endunless %}>
        <span class="pvv-dot" aria-hidden="true"></span>

        {%- if v.compare_at_price > v.price -%}
          <span class="pvv-badge">Économisez {{ v.compare_at_price | minus: v.price | money_without_trailing_zeros }}</span>
        {%- endif -%}

        {%- if v.featured_media -%}
          <img class="pvv-img" width="72" height="72" loading="lazy"
               src="{{ v.featured_media | image_url: width: 144 }}"
               alt="{{ v.title | escape }}">
        {%- else -%}
          <svg class="pvv-img" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="6" y="3" width="12" height="18" rx="3" fill="none" stroke="currentColor"/>
          </svg>
        {%- endif -%}

        <div class="pvv-title">{{ v.title }}</div>
        <div class="pvv-price">
          {%- if v.compare_at_price > v.price -%}
            <span class="pvv-compare">{{ v.compare_at_price | money_without_trailing_zeros }}</span>
          {%- endif -%}
          <span class="pvv-final">{{ v.price | money_without_trailing_zeros }}</span>
        </div>
      </label>
    {%- endfor -%}
  </fieldset>
</div>

<style>
  #pvv-{{ section.id }}-{{ block.id }} .pvv-grid{
    --pv-border:#D7DADB; --pv-selected:#294869; --pv-dot:#111; --pv-bg:#F7F8F9;
    display:grid; gap:14px; grid-template-columns:1fr; margin:10px 0 18px;
  }
  @media(min-width:700px){
    #pvv-{{ section.id }}-{{ block.id }} .pvv-grid{ grid-template-columns:repeat(2,1fr); }
  }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-card{
    position:relative; border:1.5px solid var(--pv-border); border-radius:14px; padding:22px;
    background:#fff; display:grid; place-items:center; min-height:160px; cursor:pointer; transition:.2s;
  }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-card:hover{ background:var(--pv-bg); }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-card[aria-pressed="true"]{
    border-color:var(--pv-selected); box-shadow:0 0 0 2px rgba(41,72,105,.18);
  }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-card[aria-disabled="true"],
  #pvv-{{ section.id }}-{{ block.id }} .pvv-radio:disabled ~ *{ opacity:.45; cursor:not-allowed; }

  #pvv-{{ section.id }}-{{ block.id }} .pvv-dot{
    position:absolute; top:10px; right:10px; width:18px; height:18px; border-radius:999px; border:2px solid #111; background:#fff; display:grid; place-items:center;
  }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-card[aria-pressed="true"] .pvv-dot::after{
    content:""; width:10px; height:10px; border-radius:999px; background:var(--pv-dot);
  }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-img{ width:72px; height:72px; object-fit:contain; margin-bottom:10px; }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-title{ font-weight:700; font-size:14px; margin-bottom:6px; text-align:center; }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-price{ font-weight:700; font-size:14px; }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-compare{ opacity:.55; text-decoration:line-through; margin-right:8px; font-weight:500; }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-badge{ position:absolute; top:10px; left:10px; background:#111; color:#fff; font-size:12px; font-weight:700; border-radius:10px; padding:4px 8px; line-height:1; }
  #pvv-{{ section.id }}-{{ block.id }} .pvv-radio{ position:absolute; opacity:0; pointer-events:none; }
/* Supprimer le cadre autour du groupe */
#pvv-{{ section.id }}-{{ block.id }} fieldset,
#pvv-{{ section.id }}-{{ block.id }} .pvv-grid{
  border: none;
  padding: 0;
  margin: 0;
  outline: none;
  box-shadow: none;
}

/* (optionnel) s’assurer qu’aucun conteneur n’ajoute de bordure */
#pvv-{{ section.id }}-{{ block.id }}{
  border: none;
  background: transparent;
  box-shadow: none;
}

</style>

<script>
  (function(){
    const root = document.getElementById('pvv-{{ section.id }}-{{ block.id }}');
    if(!root) return;

    // Shrine Pro : tente d'abord l'id standard product-form-{{ section.id }}
    const form = document.getElementById('product-form-{{ section.id }}')
             || root.closest('section')?.querySelector('form[action*="/cart/add"]')
             || document.querySelector('form[action*="/cart/add"]');

    if(!form){ console.warn('[pvv] Form produit introuvable'); return; }

    const select = form.querySelector('select[name="id"]') || form.querySelector('input[name="id"]');
    if(!select){ console.warn('[pvv] Champ variante introuvable'); return; }

    function selectVariant(id){
      if(select.tagName === 'SELECT'){
        select.value = String(id);
        select.dispatchEvent(new Event('change',{bubbles:true}));
      } else {
        select.value = String(id);
        form.dispatchEvent(new Event('change',{bubbles:true}));
      }
      root.querySelectorAll('.pvv-card').forEach(c => c.setAttribute('aria-pressed', String(c.dataset.vid === String(id))));
    }

    root.querySelectorAll('.pvv-radio').forEach(r => {
      r.addEventListener('change', e => selectVariant(e.target.value));
    });

    // init
    const current = (select && ('value' in select)) ? select.value : '{{ product.selected_or_first_available_variant.id }}';
    selectVariant(current);
  })();
</script>
